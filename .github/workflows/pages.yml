name: Deploy GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Generate docs/index.md from the repository root README.md (no duplicate committed)
      # - name: Generate index.md from README.md
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     cat > docs/index.md <<'EOF'
      #     ---
      #     layout: default
      #     ---
      #     
      #     EOF
      #     cat README.md >> docs/index.md
      - name: Generate docs/index.md from README.md (Pages-safe)
        shell: bash
        run: |
          set -euo pipefail

          # Create front matter
          cat > docs/index.md <<'EOF'
          ---
          layout: default
          ---
          EOF

          # Append README, but strip HTML block constructs that commonly break Kramdown parsing on Pages
          # - remove <div ...> and </div>
          # - remove standalone HTML <p ...> blocks used for alignment
          # - remove raw <img ...> tags (use Markdown images instead in README, or keep them in docs)
          sed -E \
            -e '/^[[:space:]]*<div[^>]*>[[:space:]]*$/d' \
            -e '/^[[:space:]]*<\/div>[[:space:]]*$/d' \
            -e '/^[[:space:]]*<p[^>]*>[[:space:]]*$/d' \
            -e '/^[[:space:]]*<\/p>[[:space:]]*$/d' \
            -e '/^[[:space:]]*<img[^>]*>[[:space:]]*$/d' \
            README.md >> docs/index.md

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
