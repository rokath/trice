name: "CodeQL"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# DESIGN NOTES
# ------------
# 1) Split jobs by language to avoid coupling:
#    - Go can usually be analyzed without complex build tooling.
#    - C/C++ CodeQL benefits from observing *actual* compilation commands.
#
# 2) Avoid running ./testAll.sh inside CodeQL:
#    testAll.sh is a full QA pipeline (formatting, markdown linting, link checks,
#    coverage, ID regeneration, cross-toolchains). That increases runtime and
#    failure surface and can cause C/C++ builds to be skipped depending on
#    tool availability on the runner.
#
# 3) Instead, run the build scripts that actually compile the C/C++ targets.
#    This provides CodeQL with clean, deterministic compilation observability.

jobs:
  analyze-go:
    name: "Analyze (CodeQL) - Go"
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL (Go)
        uses: github/codeql-action/init@v4
        with:
          languages: go
          # Optional: broader queries
          # queries: security-and-quality

      # Optional: build the trice tool exactly as you do locally.
      # If buildTriceTool.sh expects extra tooling, add it here.
      - name: Build trice tool (optional)
        shell: bash
        run: |
          chmod +x ./buildTriceTool.sh
          ./buildTriceTool.sh

      # Alternatively (or additionally), run tests:
      # - name: Go tests
      #   run: go test ./...

      - name: Perform CodeQL Analysis (Go)
        uses: github/codeql-action/analyze@v4

  analyze-cpp:
    name: "Analyze (CodeQL) - C/C++"
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Initialize CodeQL (C/C++)
        uses: github/codeql-action/init@v4
        with:
          languages: cpp
          # Manual mode: we provide the build commands explicitly.
          build-mode: manual
          # Optional: query suite
          # queries: security-and-quality

      # Install baseline build tooling.
      # Add packages as needed to satisfy your scripts.
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential make

      # Manual build step: run only the scripts that compile C/C++.
      # Start minimal; add toolchain-specific scripts only if needed.
      - name: Build C/C++ targets (manual)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x \
            ./examples/buildAllTargets_TRICE_OFF.sh \
            ./examples/buildAllTargets_TRICE_ON.sh

          # These two builds typically give good coverage of conditional compilation:
          ./examples/buildAllTargets_TRICE_OFF.sh
          ./examples/buildAllTargets_TRICE_ON.sh

          # Optional (enable later if it works reliably on ubuntu-latest):
          # chmod +x ./examples/L432_inst/all_configs_build.sh
          # ./examples/L432_inst/all_configs_build.sh
          #
          # Optional clang-based build (enable later if desired):
          # sudo apt-get install -y clang
          # chmod +x ./examples/G0B1_inst/build_with_clang.sh
          # (cd ./examples/G0B1_inst && ./build_with_clang.sh)

      - name: Perform CodeQL Analysis (C/C++)
        uses: github/codeql-action/analyze@v4
